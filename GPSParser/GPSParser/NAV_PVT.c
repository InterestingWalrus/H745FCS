#include"NAV_PVT.h"
#include <stdio.h>
#include <string.h>

const unsigned char UBX_HEADER[] = { 0xB5, 0x62 };

NAV_PVT pvt;
GPS gps;

char sample_stream[100] = { 0xB5,0x62,0x01,0x07,0x5C,0x00,0xC8,0x41,0x6A,0x09,0xE4,0x07,0x08,0x1F,0x13,0x34,
						   0x14,0x37,0x02,0x00,0x00,0x00,0xB5,0x39,0xC2,0x23,0x03,0x03,0x1A,0x15,0x27,0xD5,
						   0x43,0xFF,0x1C,0xBF,0x73,0x1F,0x6F,0xA1,0x01,0x00,0xF2,0xE8,0x00,0x00,0xAA,0x01,
						   0x00,0x00,0x21,0x02,0x00,0x00,0x03,0x00,0x00,0x00,0xF6,0xFF,0xFF,0xFF,0xE6,0xFF,
						   0xFF,0xFF,0x0B,0x00,0x00,0x00,0xAE,0xB5,0xE8,0x00,0x60,0x00,0x00,0x00,0xD6,0x1F,
						   0x49,0x00,0x6B,0x00,0x00,0x00,0xE0,0x4A,0x23,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
						   0x00,0x00,0x77,0x82 };


void calcChecksum(unsigned char* CK)
{
	memset(CK, 0, 2);
	for (int i = 0; i < (int)sizeof(NAV_PVT); i++)
	{
		CK[0] = CK[0] + ((unsigned char*)(&pvt))[i];
		CK[1] = CK[1] + CK[0];
	}

}

void processGPS()
{
	int segment_count = 0;
	unsigned char checksum[2];
	const int data_size = sizeof(NAV_PVT);

	char header[2];
	memcpy(header, sample_stream, 2);

	memcpy(&pvt, sample_stream + 2, sizeof(NAV_PVT));

	gps.latitude = pvt.latitude * 1.0e-7;
	gps.longitude = pvt.longitude * 1.0e-7;
	gps.altitude = pvt.height / 1000.0f; 
	
	// format to ENU
	gps.vel_x = pvt.velE / 1000.0f;  
	gps.vel_y = pvt.velN / 1000.0f;
	gps.vel_z = pvt.velD / -1000.0f;
	gps.gndSpeed = pvt.gSpeed / 1000.0f;


}

